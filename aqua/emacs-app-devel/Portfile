# -*- coding: utf-8; mode: tcl; tab-width: 4; indent-tabs-mode: nil; c-basic-offset: 4 -*- vim:fenc=utf-8:ft=tcl:et:sw=4:ts=4:sts=4
# $Id: Portfile 60082 2009-11-01 13:40:22Z css@macports.org $

PortSystem 1.0

name            emacs-app-devel
version         20120227

categories      aqua editors
maintainers     css

description         The GNU Emacs text editor (Cocoa version)

long_description    GNU Emacs is a self-documenting, customizable, extensible  \
                    real-time display editor. This is a port of the latest GNU \
                    Emacs source to the OpenStep (or NeXTstep) APIs, as        \
                    implemented by Cocoa on OS X. It differs from Carbon ports \
                    of GNU Emacs in that it makes a more concerted attempt     \
                    from the ground up to follow OS X desktop and UI conventions.

# Note that this distribution can support GNUstep as well, but that
# configuration is untested at this time.

homepage            http://www.gnu.org/software/emacs/
platforms           darwin
license             GPL-3+

homepage        http://www.gnu.org/software/emacs/emacs.html
master_sites    http://repo.or.cz/w/emacs.git/snapshot
distfiles       dc198438fa4fb9c1c0f9f3e8e94836f93f9ee8ef.tar.gz

checksums           md5     2c7ebbe3bbcc30b2164b1402995ad6f3 \
                    sha1    c41ef837c8dfc3b693e980a1ad23430543b5d977

worksrcdir     emacs

pre-configure {
    system "cd ${worksrcpath}; sh ./autogen.sh"
}

depends_lib     port:ncurses \
                port:texinfo

use_parallel_build      yes

patchfiles          patch-src_emacs.c.diff \
                    patch-srgb.diff \
                    disable-interlocking.patch

# if {${configure.compiler} == "clang"} {
#     patchfiles-append   patch-clang.diff
# }

post-patch {
    reinplace "s|__PREFIX__|${prefix}|" ${worksrcpath}/src/emacs.c
}

configure.args      --with-ns --without-x --without-dbus

depends_build   port:autoconf \
                port:automake

use_parallel_build  yes

destroot {
	system "cd ${worksrcpath} && make install"     
	xinstall -m 755 -d ${destroot}${applications_dir}
	file copy ${worksrcpath}/nextstep/Emacs.app \
		${destroot}${applications_dir}
	file copy ${filespath}/site-start.el \
		${destroot}${applications_dir}/Emacs.app/Contents/Resources/site-lisp
}

post-destroot {
    reinplace "s|__PREFIX__|${prefix}|g" \
        ${destroot}${applications_dir}/Emacs.app/Contents/Resources/site-lisp/site-start.el
}

# patch-fullscreen.diff
#   http://gist.github.com/291150
#   http://www.sanityinc.com/full-screen-support-for-cocoa-emacs-on-osx
variant fullscreen description {Add fullscreen patch} {
    patchfiles-append   patch-fullscreen.diff
}

# inline and font patches are fetched from MacEmacsJP.
#   http://svn.sourceforge.jp/svnroot/macemacsjp/inline_patch/trunk/
#   revision 574.
# patch-macemacsjp-inline.diff <= emacs-inline.patch
# patch-macemacsjp-jpfont.diff <= font.patch
#
# These currently don't apply to Emacs24, and I don't have the expertise to update them
# variant inline description {Add inline patch from MacEmacsJP} {
#     patchfiles-append   patch-macemacsjp-inline.diff
# }

# variant jpfont description {Add Japanese font patch from MacEmacsJP} {
#     patchfiles-append   patch-macemacsjp-jpfont.diff
# }

# variant patches requires fullscreen inline jpfont description {Add all patches: fullscreen, inline and jpfont} {}

platform darwin 11 {
   # patchfiles-append    patch-fix-title-bar.diff
   # patch-lion-fullscreen.diff
   #   https://github.com/downloads/typester/emacs/emacs-23-lion-fullscreen-test.patch
   if {[variant_isset fullscreen]} {
       patchfiles-append   patch-lion-fullscreen.diff
   }
   configure.cflags-append   -fno-pie -O2
   configure.ldflags-append  -fno-pie
}

livecheck.type      md5
livecheck.url       http://repo.or.cz/w/emacs.git/snapshot/master.tar.gz
livecheck.md5       2c7ebbe3bbcc30b2164b1402995ad6f3
